# Drink Mixing Machine Controller

This repository provides the source code for the RP2040 based stepper driver controller.
Further documentation of the hardware can be found in
the [main](https://git.uni-due.de/embedded-systems/student-projects/ss23-drink-mixing-machine/main) repository.

**The main branch of this repository can be considered stable and should be working at all time.**

## Local DEV Environment

### Toolchain

Required tools for the toolchain are:

- gcc (C-Compiler)
- arm-none-eabi-gcc (ARM C-Compiler)
- CMake (Build Script Generator)
- Ninja/Make (Build Tool)

### Build with CMake

#### Genrate Build Scripts

The build scripts can be generated by executing CMake in your Terminal as follows:

```bash
cmake -B build/<profile> -DUNIT_TEST:BOOL=<ON/OFF>  -DDEBUG:BOOL=<ON/OFF> -DCMAKE_BUILD_TYPE=<Debug/MinSizeRel>
```

The profile is one of three:

- _debug_
- _release_
- _unittest_

The `UNIT_TEST` option should be _ON_ for the unit-test profile and otherwise _OFF_.

The `DEBUG` option should be _OFF_ for the release profile and otherwise _ON_ to enable enhanced debug output.

The `CMAKE_BUILD_TYPE` option should be set to _MinSizeRel_ for the final targets to flash the machine for operations,
because otherwise the application provides too much output, that disturb the Python-based control application.

#### Build Targets

The targets to flash the Tiny2040 can be built by running

```bash
cmake --build build/<profile> -j4
```

The profile is one of three:

- _debug_
- _release_
- _unit-test_

## Contribution Guidelines

The source code should be formatted according to the style specified in the [.clang-format](.clang-format) file.

There are no direct commits to the main branch allowed.
If you want to contribute source-code, feel free to open a merge request with your desired changes.

### Folder Structure

The source code for the target device can be found under [src](src).
The [integration](test/integration) folder provides you with the integration tests which also double as an example for
the usage of the provided libraries.
The unit-tests aim to be executed on the local machine/server and are implemented under [unit](test/unit).

## Troubleshooting

### Serial Communication (Debugging)

The application detects the end of a send command by searching for _EOL_ (0x0A) or `\n`.
This character is not on the standard keyboard!
In minicom, for example, it can be sent with `CTRL+J`.

### Stepper Driver not working

Try with Arduino mega with example code from the TMC2209 library each stepper driver.
If the stepper driver is still not working, test after taking each of those steps:

- Check each connection
- Make sure TX and RX are correctly wired
- Use multiple different stepper drivers
- Use different USB cable to connect your computer
- Replace resistors
- Try with a different computer

If it works with the Arduino, the connections are all correct.
Try again with the pico.
If it does not work:

- Replace the pico
- Use different cable to connect your computer
- Use a different computer
